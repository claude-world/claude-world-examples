# 正式環境就緒檢查清單

> 上線前：使用 Claude 進行系統性審查框架。

## 為何重要

未經檢查清單就部署到正式環境會導致：
- 在正式環境中發現安全漏洞
- 真實負載下的效能問題
- 缺少錯誤處理導致靜默失敗
- 日誌不足導致除錯盲點

本指南提供 Claude 輔助的正式環境審查框架。

## 檢查清單

### 1. 安全審查

```
┌────────────────────────────────────────────────────────────────┐
│                      安全檢查清單                               │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  □ 身份驗證                                                    │
│    ├── [ ] 密碼使用雜湊（bcrypt/argon2，非 MD5/SHA1）          │
│    ├── [ ] Token 是 httpOnly cookies（非 localStorage）        │
│    ├── [ ] Token 過期時間合理（15分鐘-24小時）                  │
│    ├── [ ] 實作 Refresh Token 輪換                             │
│    └── [ ] 登入失敗的速率限制                                   │
│                                                                │
│  □ 授權                                                        │
│    ├── [ ] 每個端點檢查權限                                     │
│    ├── [ ] 無直接物件參考（使用 UUIDs）                         │
│    ├── [ ] 管理功能需要 admin 角色                              │
│    └── [ ] API 金鑰適當限制範圍                                 │
│                                                                │
│  □ 輸入驗證                                                    │
│    ├── [ ] 所有使用者輸入在伺服器端驗證                         │
│    ├── [ ] SQL 注入防護（參數化查詢）                           │
│    ├── [ ] XSS 防護（輸出編碼）                                 │
│    └── [ ] 檔案上傳驗證（類型、大小、內容）                     │
│                                                                │
│  □ 機密資訊                                                    │
│    ├── [ ] 程式碼或 git 歷史中無機密                            │
│    ├── [ ] 所有機密使用環境變數                                 │
│    ├── [ ] .env 檔案在 .gitignore 中                           │
│    └── [ ] 任何暴露後輪換機密                                   │
│                                                                │
│  □ 相依套件                                                    │
│    ├── [ ] 無已知漏洞（npm audit / snyk）                      │
│    ├── [ ] 相依套件為最新                                       │
│    └── [ ] Lock 檔案已 commit（package-lock.json）             │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

**Claude 指令**：
```
"Run a security audit on this codebase. Check for:
- Authentication issues
- Authorization bypasses
- Input validation gaps
- Exposed secrets
- Vulnerable dependencies"
```

### 2. 效能審查

```
┌────────────────────────────────────────────────────────────────┐
│                     效能檢查清單                                │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  □ 資料庫                                                      │
│    ├── [ ] 常查詢欄位有索引                                     │
│    ├── [ ] 無 N+1 查詢模式                                     │
│    ├── [ ] 連線池已配置                                         │
│    ├── [ ] 慢查詢日誌已啟用                                     │
│    └── [ ] 查詢逾時限制已設定                                   │
│                                                                │
│  □ API                                                         │
│    ├── [ ] 回應時間 < 200ms（p95）                             │
│    ├── [ ] 列表端點有分頁                                       │
│    ├── [ ] 回應大小有限制                                       │
│    ├── [ ] 快取標頭（ETags、Cache-Control）                    │
│    └── [ ] 壓縮已啟用（gzip/brotli）                           │
│                                                                │
│  □ 前端                                                        │
│    ├── [ ] Bundle 大小已優化（程式碼分割）                      │
│    ├── [ ] 圖片已優化（WebP、延遲載入）                         │
│    ├── [ ] 關鍵 CSS 內聯                                       │
│    ├── [ ] Core Web Vitals 通過（LCP、FID、CLS）               │
│    └── [ ] 靜態資源 CDN 已配置                                  │
│                                                                │
│  □ 負載處理                                                    │
│    ├── [ ] 所有端點有速率限制                                   │
│    ├── [ ] 負載下優雅降級                                       │
│    ├── [ ] 記憶體限制已配置                                     │
│    └── [ ] 自動擴展已配置（如適用）                             │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

**Claude 指令**：
```
"Analyze performance of this codebase:
- Find N+1 queries
- Identify missing indexes
- Check for unbounded data fetching
- Review caching strategy"
```

### 3. 可靠性審查

```
┌────────────────────────────────────────────────────────────────┐
│                     可靠性檢查清單                              │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  □ 錯誤處理                                                    │
│    ├── [ ] 所有非同步操作有 try/catch                          │
│    ├── [ ] 錯誤有有意義的訊息                                   │
│    ├── [ ] 錯誤碼有文件                                         │
│    ├── [ ] 未處理 rejection 處理器                              │
│    └── [ ] 優雅的錯誤頁面（非堆疊追蹤）                         │
│                                                                │
│  □ 韌性                                                        │
│    ├── [ ] 外部 API 呼叫有逾時                                 │
│    ├── [ ] 暫時失敗的重試邏輯與退避                             │
│    ├── [ ] 失敗相依的斷路器                                     │
│    ├── [ ] 後備行為已定義                                       │
│    └── [ ] 健康檢查端點（/health）                              │
│                                                                │
│  □ 資料完整性                                                  │
│    ├── [ ] 多步驟操作使用資料庫交易                             │
│    ├── [ ] 適用處使用冪等操作                                   │
│    ├── [ ] 備份策略有文件                                       │
│    └── [ ] 資料遷移已測試                                       │
│                                                                │
│  □ 部署                                                        │
│    ├── [ ] 零停機部署策略                                       │
│    ├── [ ] 回滾程序有文件                                       │
│    ├── [ ] 資料庫遷移可逆                                       │
│    └── [ ] 風險變更使用功能旗標                                 │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

**Claude 指令**：
```
"Review error handling and resilience:
- Find unhandled promise rejections
- Check for missing timeouts on external calls
- Verify transaction usage
- Identify single points of failure"
```

### 4. 可觀測性審查

```
┌────────────────────────────────────────────────────────────────┐
│                    可觀測性檢查清單                             │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  □ 日誌                                                        │
│    ├── [ ] 結構化日誌（JSON 格式）                             │
│    ├── [ ] 所有日誌有 Request ID                               │
│    ├── [ ] 驗證請求有 User ID                                  │
│    ├── [ ] 日誌無敏感資料（密碼、token）                        │
│    ├── [ ] 日誌等級使用適當                                     │
│    └── [ ] 日誌傳送到中央位置                                   │
│                                                                │
│  □ 監控                                                        │
│    ├── [ ] 應用程式指標已收集                                   │
│    ├── [ ] 錯誤率追蹤                                           │
│    ├── [ ] 回應時間追蹤                                         │
│    ├── [ ] 資料庫查詢指標                                       │
│    └── [ ] 業務指標（註冊、轉換）                               │
│                                                                │
│  □ 警報                                                        │
│    ├── [ ] 錯誤率飆升警報                                       │
│    ├── [ ] 回應時間降級警報                                     │
│    ├── [ ] 磁碟空間/記憶體警報                                  │
│    ├── [ ] SSL 憑證到期警報                                     │
│    └── [ ] 值班輪換已定義                                       │
│                                                                │
│  □ 除錯                                                        │
│    ├── [ ] Source maps 在正式環境可用                          │
│    ├── [ ] 錯誤追蹤服務已配置（Sentry）                         │
│    ├── [ ] 請求追蹤可用                                         │
│    └── [ ] 每請求啟用除錯日誌功能                               │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

**Claude 指令**：
```
"Review logging and monitoring setup:
- Check for sensitive data in logs
- Verify structured logging format
- Identify gaps in error tracking
- Review alerting coverage"
```

### 5. 測試審查

```
┌────────────────────────────────────────────────────────────────┐
│                      測試檢查清單                               │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  □ 覆蓋率                                                      │
│    ├── [ ] 單元測試覆蓋率 > 70%                                │
│    ├── [ ] 關鍵路徑有整合測試                                   │
│    ├── [ ] API 端點有契約測試                                  │
│    └── [ ] 邊緣案例已涵蓋                                       │
│                                                                │
│  □ 品質                                                        │
│    ├── [ ] 測試是確定性的（無不穩定測試）                       │
│    ├── [ ] 每個 PR 在 CI 中執行測試                            │
│    ├── [ ] 測試資料隔離（無共享狀態）                           │
│    └── [ ] 外部服務有 Mocks                                    │
│                                                                │
│  □ 場景                                                        │
│    ├── [ ] 正常路徑已測試                                       │
│    ├── [ ] 錯誤條件已測試                                       │
│    ├── [ ] 邊界條件已測試                                       │
│    ├── [ ] 並發存取已測試                                       │
│    └── [ ] 權限邊界已測試                                       │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

**Claude 指令**：
```
"Analyze test coverage and quality:
- Identify untested critical paths
- Find flaky tests
- Check for missing edge case tests
- Verify permission testing"
```

### 6. 文件審查

```
┌────────────────────────────────────────────────────────────────┐
│                   文件檢查清單                                  │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  □ 開發者文件                                                  │
│    ├── [ ] README 有設定說明                                   │
│    ├── [ ] 架構概覽                                             │
│    ├── [ ] API 文件（OpenAPI/Swagger）                         │
│    └── [ ] 貢獻指南                                             │
│                                                                │
│  □ 維運文件                                                    │
│    ├── [ ] 部署程序                                             │
│    ├── [ ] 回滾程序                                             │
│    ├── [ ] 常見問題 Runbooks                                   │
│    └── [ ] 環境配置                                             │
│                                                                │
│  □ 程式碼文件                                                  │
│    ├── [ ] 複雜邏輯有註解                                       │
│    ├── [ ] 公開 API 有 JSDoc/docstrings                        │
│    └── [ ] 架構決策已記錄（ADRs）                               │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

## 使用 Claude 進行正式環境審查

### 步驟 1：安全掃描

```
"Perform a security review of this codebase focusing on OWASP Top 10"
```

### 步驟 2：效能分析

```
"Analyze this codebase for performance issues:
- Database query efficiency
- N+1 patterns
- Missing caching opportunities
- Bundle size issues"
```

### 步驟 3：可靠性檢查

```
"Review error handling and resilience patterns:
- Unhandled errors
- Missing timeouts
- Transaction boundaries
- Recovery mechanisms"
```

### 步驟 4：產生報告

```
"Create a production readiness report summarizing:
- Critical issues (must fix before launch)
- High priority issues (fix soon after launch)
- Medium issues (add to backlog)
- Good practices already in place"
```

## 正式環境審查會話範例

```
你："Run production readiness check before we launch next week"

Claude：[啟動 parallel agents]
→ Agent 1：安全掃描
→ Agent 2：效能分析
→ Agent 3：錯誤處理審查
→ Agent 4：測試覆蓋率檢查
→ Agent 5：文件稽核

[2 分鐘後]

Claude："Production Readiness Report:

CRITICAL（阻止上線）：
1. /api/admin/users 端點缺少 auth 檢查（安全）
2. 使用者密碼使用 MD5 儲存（安全）

HIGH PRIORITY（1 週內修復）：
1. /api/projects 有 N+1 查詢（效能）
2. auth 端點無速率限制（安全）
3. 支付流程缺少錯誤處理（可靠性）

MEDIUM（加入待辦）：
1. 測試覆蓋率 45%（目標：70%）
2. 無結構化日誌
3. 缺少 API 文件

良好：
✓ 使用 Zod 進行輸入驗證
✓ HTTPS 強制
✓ 相依套件為最新
✓ 健康檢查端點存在"
```

## 上線後檢查清單

```
┌────────────────────────────────────────────────────────────────┐
│                   上線後檢查清單                                │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  □ 上線後立即                                                  │
│    ├── [ ] 驗證所有服務執行中                                   │
│    ├── [ ] 檢查錯誤率（應接近零）                               │
│    ├── [ ] 驗證關鍵使用者流程正常                               │
│    └── [ ] 監控異常流量模式                                     │
│                                                                │
│  □ 前 24 小時                                                  │
│    ├── [ ] 審查所有發生的錯誤                                   │
│    ├── [ ] 檢查效能指標 vs 預期                                 │
│    ├── [ ] 驗證日誌捕獲預期資料                                 │
│    └── [ ] 收集初步使用者回饋                                   │
│                                                                │
│  □ 第一週                                                      │
│    ├── [ ] 處理發現的任何問題                                   │
│    ├── [ ] 審查使用模式                                         │
│    ├── [ ] 調整警報閾值                                         │
│    └── [ ] 記錄學習經驗                                         │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

## 總結

使用此檢查清單與 Claude 系統性審查：

1. **安全** - 驗證、輸入驗證、機密、相依套件
2. **效能** - 資料庫、API、前端、負載處理
3. **可靠性** - 錯誤處理、韌性、資料完整性
4. **可觀測性** - 日誌、監控、警報
5. **測試** - 覆蓋率、品質、場景
6. **文件** - 開發者、維運、程式碼

**執行完整審查的指令**：
```
"Perform a complete production readiness review using the standard checklist"
```

---

另請參閱：[快速參考卡](./quick-reference.md) | [安全最佳實踐](./security-best-practices.md)
